<!doctype html><html lang=zh-cn class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.91.2">
<link rel=canonical type=text/html href=https://xiaoping378.github.io/docs/3-devops/tidb/>
<link rel=alternate type=application/rss+xml href=https://xiaoping378.github.io/docs/3-devops/tidb/index.xml>
<meta name=robots content="noindex, nofollow">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<title>TiDB分布式数据库 | 现代技能栈</title>
<meta name=description content="TiDB分布式数据库的介绍和深度探索
">
<meta property="og:title" content="TiDB分布式数据库">
<meta property="og:description" content="TiDB分布式数据库的介绍和深度探索
">
<meta property="og:type" content="website">
<meta property="og:url" content="https://xiaoping378.github.io/docs/3-devops/tidb/"><meta property="og:site_name" content="现代技能栈">
<meta itemprop=name content="TiDB分布式数据库">
<meta itemprop=description content="TiDB分布式数据库的介绍和深度探索
"><meta name=twitter:card content="summary">
<meta name=twitter:title content="TiDB分布式数据库">
<meta name=twitter:description content="TiDB分布式数据库的介绍和深度探索
">
<link rel=preload href=/scss/main.min.d2bc7f6ad2027b8d511d38a54c20b15ad4617ecaa1fa8f57365017fe6f7ced3d.css as=style>
<link href=/scss/main.min.d2bc7f6ad2027b8d511d38a54c20b15ad4617ecaa1fa8f57365017fe6f7ced3d.css rel=stylesheet integrity>
<script src=/js/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=/js/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','UA-217913492-1','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo></span><span class="text-uppercase font-weight-bold">现代技能栈</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/about/><span>关于</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/docs/><span class=active>文档</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/blog/><span>博客</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/community/><span>社区</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.fc99457703d70784c03b4b46448db8d5.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/docs/3-devops/tidb/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>TiDB分布式数据库</h1>
<div class=lead>TiDB分布式数据库的介绍和深度探索</div>
<ul>
<li>1: <a href=#pg-07ef033d5a20184955fad1e45f4c9e36>TiDB初体验</a></li>
</ul>
<div class=content>
<div class="pageinfo pageinfo-primary">
<p>主要介绍TiDB周边生态和实践体验</p>
</div>
</div>
</div>
<div class=td-content>
<h1 id=pg-07ef033d5a20184955fad1e45f4c9e36>1 - TiDB初体验</h1>
<div class=lead>TiDB 初体验安装介绍</div>
<h2 id=安装>安装</h2>
<blockquote>
<p>安装环境要求：</p>
<ul>
<li>Mac或者单机Linux环境</li>
<li>可以连接外网</li>
</ul>
</blockquote>
<ol>
<li>执行命令安装<code>TiUP</code>工具，官方运维管理工具。</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl --proto <span style=color:#b44>&#39;=https&#39;</span> --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh
</code></pre></div><p>命令会有关键信息输出:添加了证书、修改了PATH变量等，需要声明下环境变量，以使<code>tiup</code>命令能被找到。</p>
<ol start=2>
<li>声明系统环境变量</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#080;font-style:italic># 因个人环境，此处会有差异</span>
<span style=color:#a2f>source</span> ~/.zshrc
</code></pre></div><p>可以<code>echo $PATH</code>下，看到<code>/root/.tiup/bin</code>被加到了最前面。</p>
<ol start=3>
<li>启动单实例集群</li>
</ol>
<p>直接执行<code>tiup playground</code>命令默认会运行最新版本的TiDB集群，其中TiDB Server、TiKV、PD 和 TiFlash 实例各 1 个：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>tiup playground
</code></pre></div><p>具体如下图所示，需要另开一个终端，使用mysql发起连接：
<img src=/images/github-dev-2022-02-04-16-16-18.png alt></p>
<p>目前tidb playground默认启动监听在127的地址，可以通过--host参数更改，但还不能更改端口（经查代码是写死了端口）。</p>
<ul>
<li>其他可修改参数，可通过<code>tiup playground -h</code>查看。</li>
<li>dashboard的默认root用户没有密码，如果是公网暴露了，建议如下添加密码(我这里设置了root密码为<code>tidb</code>):</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql -h127.0.0.1 -P4000 -uroot
alter user <span style=color:#b44>&#39;root&#39;</span> identified by <span style=color:#b44>&#39;tidb&#39;</span>;
</code></pre></div><ul>
<li>grafana的登录密码，默认为admin/admin</li>
<li><code>tiup update --self</code>可升级tiup命令</li>
</ul>
<blockquote>
<p>mysql客户端可通过<code>yum install -y mysql</code>或者<code>apt install mysql-client</code>安装。</p>
</blockquote>
<h2 id=集群>集群</h2>
<p>没有多节点的环境，折腾了一下，要单机玩这个模式的话，需要hack的东西太多，，，目前还不建议这么搞，等有时间看能不能提个PR.</p>
<h2 id=tidb-server>TIDB Server</h2>
<p>处理client的SQL请求.</p>
<h2 id=pd>PD</h2>
<p>提供全局时钟和Region调度和管理（扩缩容）。</p>
<h2 id=tikv>TIKV</h2>
<p>使用rocksDB实现数据持久化，基于此实现了分布式存储引擎，其中的核心点可以理解为以下三点：</p>
<ul>
<li>事务</li>
<li>MVCC</li>
<li>Raft</li>
</ul>
<h3 id=分布式事务percolator>分布式事务Percolator</h3>
<p>基于时间戳的两阶段提交事务解决方案。</p>
<h3 id=mvcc多版本并发控制>MVCC多版本并发控制</h3>
<p><code>COW</code>的本质。默认revision大的为最新值，</p>
<h3 id=多副本raft一致性>多副本Raft一致性</h3>
<p><strong>Leader选举：</strong></p>
<ul>
<li><code>Term</code>状态变化，follower -> (random timeout) -> candidate -> leader. 此过程因为网络延迟问题，很可能是进行多轮选举。</li>
</ul>
<pre tabindex=0><code class=language-plantuml data-lang=plantuml>@startuml
!theme aws-orange
TiKV1 -&gt; TiKV1: 随机选举时间到，切换为candidate角色，进入term2，发出选举信息
TiKV1 -&gt; TiKV2: 发起选举，term=2
TiKV1 -&gt; TiKV3: 发起选举，term=2
TiKV2 -&gt; TiKV2: 对比term（非拜占庭环境，大家默认信任term大的）
TiKV3 -&gt; TiKV3: 对比term
TiKV2 -&gt; TiKV1: 投一票
TiKV3 -&gt; TiKV1: 投一票
TiKV1 -&gt; TiKV1: 超过一半投票（2x+1），成为Leader
TiKV1 -&gt; TiKV2: 心跳保活
TiKV1 -&gt; TiKV3: 心跳保活
TiKV1 -&gt; TiKV1: 异常了
TiKV2 -&gt; TiKV2: 心跳超时，切换candidate角色，进入term3
TiKV2 -&gt; TiKV3: 发起选举
TiKV3 -&gt; TiKV2: 对比term，并投一票
TiKV2 -&gt; TiKV2: 加上自己的一票，超过一半投票，成为Leader
@enduml
</code></pre><blockquote>
<p>leader负责读写请求，follower负责数据多副本复制。日常心跳保活，出问题后，重新选举。</p>
</blockquote>
<p><strong>数据写入</strong>：</p>
<ul>
<li>propose -> append (local) -> Replicate (remote append) -> commited -> apply</li>
</ul>
<pre tabindex=0><code class=language-plantuml data-lang=plantuml>@startuml
!theme aws-orange

用户 -&gt; TiDB_Server: 发起事务数据写入
TiDB_Server -&gt; TiDB_Server: 解析语句，SQL -&gt; KV
TiDB_Server -&gt; PD: 获取KV元信息
PD -&gt; TiDB_Server: 告知该key的range leader信息（TiKV1）
TiDB_Server -&gt; TiKV1: 发起propose
TiKV1 -&gt; TiKV1: 本地append为raft_log
TiKV1 -&gt; TiKV2: 发起Replicate复制
TiKV1 -&gt; TiKV3: 发起Replicate复制
TiKV2 -&gt; TiKV2: 本地append为raft_log
TiKV3 -&gt; TiKV3: 本地append为raft_log
TiKV2 -&gt; TiKV1: 反馈已记录成功
TiKV3 -&gt; TiKV1: 反馈已记录成功
TiKV1 -&gt; TiKV1: 收到大多数节点反馈，进入commited状态
TiKV1 -&gt; TiKV2: 发起commited确认
TiKV1 -&gt; TiKV3: 发起commited确认
TiKV2 -&gt; TiKV1: 进入commited
TiKV3 -&gt; TiKV1: 进入commited
TiKV1 -&gt; TiKV1: 收到大多数节点反馈，进入apply状态，此时业务数据才算真正落盘
TiKV1 -&gt; TiKV2: 发起apply确认
TiKV1 -&gt; TiKV3: 发起apply确认
TiKV2 -&gt; TiKV1: 进入apply
TiKV3 -&gt; TiKV1: 进入apply
TiKV1 -&gt; TiDB_Server: 收到一个apply成功反馈，即可反馈用户写入成功
TiDB_Server -&gt; 用户: 反馈写入成功
@enduml
</code></pre><blockquote>
<p>SQL事务的commit对应到这里的apply，这里的commited是指raft中记录上用户的数据更新了（多数据节点记录上用户的写入请求了）。</p>
</blockquote>
<p><strong>数据读取：</strong></p>
<ul>
<li>tidb server解析SQL语句 -> 从pd获取对应key的tikv节点信息 -></li>
</ul>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="个人邮箱 xiaoping378@163.com" aria-label="个人邮箱 xiaoping378@163.com">
<a class=text-white target=_blank rel=noopener href=mailto:xiaoping378@163.com aria-label="个人邮箱 xiaoping378@163.com">
<i class="fa fa-envelope"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=微博 aria-label=微博>
<a class=text-white target=_blank rel=noopener href=https://weibo.com/xiaoping378 aria-label=微博>
<i class="fab fa-weibo"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=知乎 aria-label=知乎>
<a class=text-white target=_blank rel=noopener href=https://www.zhihu.com/people/xiaoping378 aria-label=知乎>
<i class="fab fa-zhihu"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank rel=noopener href=https://github.com/xiaoping378/xiaoping378.github.io aria-label=GitHub>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank rel=noopener href=https://example.org/slack aria-label=Slack>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list">
<a class=text-white target=_blank rel=noopener href=https://example.org/mail aria-label="Developer mailing list">
<i class="fa fa-envelope"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2024 xiaoping378 保留所有权利</small>
<small class=ml-1><a href=# target=_blank rel=noopener>隐私政策</a></small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/deflate.js></script>
<script src=/js/main.min.e016890ed6b0c42f5af3410eb57ac626a192a868609aee68cefe1e0f84a50b13.js integrity="sha256-4BaJDtawxC9a80EOtXrGJqGSqGhgmu5ozv4eD4SlCxM=" crossorigin=anonymous></script>
</body>
</html>