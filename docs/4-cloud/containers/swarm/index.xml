<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Swarm篇 on 现代技能栈</title><link>https://xiaoping378.github.io/docs/4-cloud/containers/swarm/</link><description>Recent content in Swarm篇 on 现代技能栈</description><generator>Hugo</generator><language>zh-cn</language><atom:link href="https://xiaoping378.github.io/docs/4-cloud/containers/swarm/index.xml" rel="self" type="application/rss+xml"/><item><title>构建生产环境级的docker Swarm集群-1</title><link>https://xiaoping378.github.io/docs/4-cloud/containers/swarm/docker-swarm/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://xiaoping378.github.io/docs/4-cloud/containers/swarm/docker-swarm/</guid><description>&lt;p&gt;此文档适用于低于1.12版本的docker，之后swarm已内置于docker-engine里。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;硬件需求&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;至少5台PC服务器, 分别如下作用&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;manager0&lt;/li&gt;
&lt;li&gt;manager1&lt;/li&gt;
&lt;li&gt;consul0&lt;/li&gt;
&lt;li&gt;node0&lt;/li&gt;
&lt;li&gt;node1&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="2"&gt;
&lt;li&gt;每台PC上安装docker-engine&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;一台一台的ssh上去执行，或者使用ansible批量部署工具。&lt;/p&gt;
&lt;p&gt;安装docker-engine&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;curl -sSL https://get.docker.com/ | sh
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;启动之，并使之监听2375端口&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;sudo docker daemon -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;亦可修改配置，使之永久生效&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;mkdir /etc/systemd/system/docker.service.d
cat &amp;lt;&amp;lt;EOF &amp;gt;&amp;gt;/etc/systemd/system/docker.service.d/docker.conf
[Service]
 ExecStart=
 ExecStart=/usr/bin/docker daemon -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --dns 180.76.76.76 --insecure-registry registry.cecf.com -g /home/Docker/docker
EOF
&lt;/code&gt;&lt;/pre&gt;&lt;ol start="3"&gt;
&lt;li&gt;启动discovery后台&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在consul0上启动consul服务，manager用其来认证node连接并存储node状态， 理应建立discovery的高可用，这里简化之&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;docker run -d -p 8500:8500 --name=consul progrium/consul -server -bootstrap
&lt;/code&gt;&lt;/pre&gt;&lt;ol start="4"&gt;
&lt;li&gt;创建Swarm集群&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在manager0上创建the primary manager， 自行替换manager0_ip和consul0_ip的真实IP地址。&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;docker run -d -p 4000:4000 swarm manage -H :4000 --replication --advertise &amp;lt;manager0_ip&amp;gt;:4000 consul://&amp;lt;consul0_ip&amp;gt;:8500
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;在manager1上启动replica manger&lt;/p&gt;</description></item><item><title>构建生产环境级的docker Swarm集群-2</title><link>https://xiaoping378.github.io/docs/4-cloud/containers/swarm/docker-swarm2/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://xiaoping378.github.io/docs/4-cloud/containers/swarm/docker-swarm2/</guid><description>&lt;p&gt;此文档适用于不低于1.12版本的docker，因为swarm已内置于docker-engine里。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;硬件需求&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这里以5台PC服务器为例, 分别如下作用&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;manager0&lt;/li&gt;
&lt;li&gt;manager1&lt;/li&gt;
&lt;li&gt;node0&lt;/li&gt;
&lt;li&gt;node1&lt;/li&gt;
&lt;li&gt;node2&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="2"&gt;
&lt;li&gt;每台PC上安装docker-engine&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;一台一台的ssh上去执行，或者使用ansible批量部署工具。&lt;/p&gt;
&lt;p&gt;安装docker-engine&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;curl -sSL https://get.docker.com/ | sh
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;启动之，并使之监听2375端口&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;sudo docker daemon -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;亦可修改配置，使之永久生效&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;mkdir /etc/systemd/system/docker.service.d
cat &amp;lt;&amp;lt;EOF &amp;gt;&amp;gt;/etc/systemd/system/docker.service.d/docker.conf
[Service]
 ExecStart=
 ExecStart=/usr/bin/docker daemon -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --dns 180.76.76.76 --insecure-registry registry.cecf.com -g /home/Docker/docker
EOF
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;如果开启了防火墙，需要开启如下端口&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;TCP port 2377&lt;/strong&gt; for cluster management communications&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;TCP&lt;/strong&gt; and &lt;strong&gt;UDP port 7946&lt;/strong&gt; for communication among nodes&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;TCP&lt;/strong&gt; and &lt;strong&gt;UDP port 4789&lt;/strong&gt; for overlay network traffic&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="3"&gt;
&lt;li&gt;创建swarm&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;docker swarm init --advertise-addr &amp;lt;MANAGER-IP&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;我的实例里如下：&lt;/p&gt;</description></item><item><title>构建生产环境级的docker Swarm集群-3</title><link>https://xiaoping378.github.io/docs/4-cloud/containers/swarm/docker-sarm3/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://xiaoping378.github.io/docs/4-cloud/containers/swarm/docker-sarm3/</guid><description>&lt;p&gt;如前文所述，默认已经搭建好环境，基于docker1.12版本。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#666"&gt;[&lt;/span&gt;root@manager0 ~&lt;span style="color:#666"&gt;]&lt;/span&gt;&lt;span style="color:#080;font-style:italic"&gt;# docker node ls&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ID HOSTNAME STATUS AVAILABILITY MANAGER STATUS
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;0bbmd3r7aphs374qaea4zcieo node2 Ready Active
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;3qmxzyauc0bz4kjqvld9uogz5 manager1 Ready Active Reachable
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;5ewbdtvaopj4ltwqx0a4i65nt * manager0 Ready Drain Leader
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;5oxxpgk69fnwe5w210kovrqi9 node1 Ready Active
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;7s1ilay2wkjgt09bp2z0743m7 node0 Ready Active
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ol&gt;
&lt;li&gt;创建第一个服务，以redis为例
swarm里容器间通信需要使用overlay模式，所以需要提前建立一个&lt;/li&gt;
&lt;/ol&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;docker network create -d overlay --subnet 10.254.0.0/16 --gateway 10.254.0.1 mynet1
docker service create --name redis --network mynet1 redis
&lt;/code&gt;&lt;/pre&gt;&lt;ol start="2"&gt;
&lt;li&gt;在manager上查看服务部署情况&lt;/li&gt;
&lt;/ol&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;[root@manager0 ~]# docker service ps redis
ID NAME IMAGE NODE DESIRED STATE CURRENT STATE ERROR
9avksjfqr2gxm413dfrezrmgr redis.1 redis node1 Running Running 17 seconds ago
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;实例里，同样可以去node1上用&lt;code&gt;docker ps&lt;/code&gt;查看&lt;/p&gt;</description></item></channel></rss>