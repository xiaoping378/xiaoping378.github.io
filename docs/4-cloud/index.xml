<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>云原生 on 现代技能栈</title><link>https://xiaoping378.github.io/docs/4-cloud/</link><description>Recent content in 云原生 on 现代技能栈</description><generator>Hugo</generator><language>zh-cn</language><atom:link href="https://xiaoping378.github.io/docs/4-cloud/index.xml" rel="self" type="application/rss+xml"/><item><title>KVM和Libvirt的实践整理</title><link>https://xiaoping378.github.io/docs/4-cloud/kvm-virsh%E5%AE%9E%E8%B7%B5%E6%95%B4%E7%90%86/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://xiaoping378.github.io/docs/4-cloud/kvm-virsh%E5%AE%9E%E8%B7%B5%E6%95%B4%E7%90%86/</guid><description>&lt;h2 id="介绍"&gt;介绍&lt;a class="td-heading-self-link" href="#%e4%bb%8b%e7%bb%8d" aria-label="Heading self-link"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;此前一直用Virtualbox操作虚机的东西，对于个人搭建环境还是显的有些笨重，不能实现Iac的目标，故尝试了Vagrant和Libvirt，综合考虑我选择libvirt继续深入下去，也是希望以后有机会可以深入搞下openstack的nova组件。&lt;/p&gt;
&lt;h2 id="安装必要依赖"&gt;安装必要依赖&lt;a class="td-heading-self-link" href="#%e5%ae%89%e8%a3%85%e5%bf%85%e8%a6%81%e4%be%9d%e8%b5%96" aria-label="Heading self-link"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo apt install bridge-utils qemu-kvm virtinst -y
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;qemu-kvm: 这个负责hypervisor层和仿真器（可以模拟x86, arm体系）.&lt;/li&gt;
&lt;li&gt;virtinst: 安装和管理虚机的命令行工具&lt;/li&gt;
&lt;li&gt;bridge-utils： 创建和管理bridge网络&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;安装完输入&lt;code&gt;kvm-ok&lt;/code&gt;查看是否安装OK，另外还&lt;code&gt;需要重启&lt;/code&gt;以使kvm和libvirt daemon启动。&lt;/p&gt;
&lt;h2 id="配置网络"&gt;配置网络&lt;a class="td-heading-self-link" href="#%e9%85%8d%e7%bd%ae%e7%bd%91%e7%bb%9c" aria-label="Heading self-link"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;未完。。。&lt;/p&gt;</description></item><item><title>Vagrant实践整理</title><link>https://xiaoping378.github.io/docs/4-cloud/vagrant%E7%9A%84%E4%BD%BF%E7%94%A8/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://xiaoping378.github.io/docs/4-cloud/vagrant%E7%9A%84%E4%BD%BF%E7%94%A8/</guid><description>&lt;p&gt;很早就听说vagrant的大名，是个创建和管理虚机环境的工具，但一直没有机会实践下，近日我的VirtuablBox让我搞砸了，决定试用下，便于快速搭建各种环境。&lt;/p&gt;
&lt;h2 id="安装vagrant"&gt;安装vagrant&lt;a class="td-heading-self-link" href="#%e5%ae%89%e8%a3%85vagrant" aria-label="Heading self-link"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;图省事儿的话，直接&lt;code&gt;sudo apt install vagrant&lt;/code&gt;就可以安装，不过版本有点儿低，是1.8.1。&lt;/p&gt;
&lt;p&gt;通过官方&lt;a href="https://www.vagrantup.com/downloads.html"&gt;下载地址&lt;/a&gt;, 可直接下载最新的安装包。我这里安装的是1.9.4&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;➜ ~ vagrant -v
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Vagrant 1.9.4
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="常用命令"&gt;常用命令&lt;a class="td-heading-self-link" href="#%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4" aria-label="Heading self-link"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;一个打包好的操作系统在Vagrant中称为Box，即Box是一个打包好的操作系统环境，网上有很多打包好的环境，官方也有下载各种Boxes的&lt;a href="https://atlas.hashicorp.com/boxes/search"&gt;地址&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;一般使用流程如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;vagrant box add 添加box的操作&lt;/li&gt;
&lt;li&gt;vagrant init 初始化box的操作&lt;/li&gt;
&lt;li&gt;vagrant up 启动虚拟机的操作&lt;/li&gt;
&lt;li&gt;vagrant ssh 登录虚拟机的操作&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;额外还有些常用的命令&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;vagrant box list 显示当前已经添加的box列表&lt;/li&gt;
&lt;li&gt;vagrant box remove 删除相应的box&lt;/li&gt;
&lt;li&gt;vagrant halt -f 冷关机（切断电源）&lt;/li&gt;
&lt;li&gt;vagrant suspend 挂起当前的虚拟机&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="实践"&gt;实践&lt;a class="td-heading-self-link" href="#%e5%ae%9e%e8%b7%b5" aria-label="Heading self-link"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;目前vagrant 1.9.4支持适配VirtualBox, VMware，Hyper-V, 和 Docker，本文使用的是VirtualBox。&lt;/p&gt;
&lt;p&gt;需要你本机已经&lt;a href="https://www.virtualbox.org/wiki/Downloads"&gt;安装virtuablbox&lt;/a&gt;环境&lt;/p&gt;
&lt;p&gt;一般只要如下初始化，就会有个最新的centos-7虚机环境&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;➜ vagrant init centos/7
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;A &lt;span style="color:#b44"&gt;`&lt;/span&gt;Vagrantfile&lt;span style="color:#b44"&gt;`&lt;/span&gt; has been placed in this directory. You are now
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ready to &lt;span style="color:#b44"&gt;`&lt;/span&gt;vagrant up&lt;span style="color:#b44"&gt;`&lt;/span&gt; your first virtual environment! Please &lt;span style="color:#a2f"&gt;read&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;the comments in the Vagrantfile as well as documentation on
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#b44"&gt;`&lt;/span&gt;vagrantup.com&lt;span style="color:#b44"&gt;`&lt;/span&gt; &lt;span style="color:#a2f;font-weight:bold"&gt;for&lt;/span&gt; more information on using Vagrant.
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;➜ ls
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Vagrantfile
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;➜ vagrant up --provider virtualbox
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;Bringing machine &lt;span style="color:#b44"&gt;&amp;#39;default&amp;#39;&lt;/span&gt; up with &lt;span style="color:#b44"&gt;&amp;#39;virtualbox&amp;#39;&lt;/span&gt; provider...
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#666"&gt;==&lt;/span&gt;&amp;gt; default: Box &lt;span style="color:#b44"&gt;&amp;#39;centos/7&amp;#39;&lt;/span&gt; could not be found. Attempting to find and install...
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; default: Box Provider: virtualbox
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; default: Box Version: &amp;gt;&lt;span style="color:#666"&gt;=&lt;/span&gt; &lt;span style="color:#b8860b"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#666"&gt;==&lt;/span&gt;&amp;gt; default: Loading metadata &lt;span style="color:#a2f;font-weight:bold"&gt;for&lt;/span&gt; box &lt;span style="color:#b44"&gt;&amp;#39;centos/7&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; default: URL: https://atlas.hashicorp.com/centos/7
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#666"&gt;==&lt;/span&gt;&amp;gt; default: Adding box &lt;span style="color:#b44"&gt;&amp;#39;centos/7&amp;#39;&lt;/span&gt; &lt;span style="color:#666"&gt;(&lt;/span&gt;v1704.01&lt;span style="color:#666"&gt;)&lt;/span&gt; &lt;span style="color:#a2f;font-weight:bold"&gt;for&lt;/span&gt; provider: virtualbox
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; default: Downloading: https://atlas.hashicorp.com/centos/boxes/7/versions/1704.01/providers/virtualbox.box
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; default: Progress: 2% &lt;span style="color:#666"&gt;(&lt;/span&gt;Rate: 94086/s, Estimated &lt;span style="color:#a2f"&gt;time&lt;/span&gt; remaining: 1:52:14&lt;span style="color:#666"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;但如上需要依赖外网, 国内环境一般会下载失败，我这里介绍一种通过本地iso创建Box的方法，然后通过本地Box启动虚机环境。&lt;/p&gt;</description></item><item><title>解读Consul</title><link>https://xiaoping378.github.io/docs/4-cloud/%E8%A7%A3%E8%AF%BBconsu-01/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://xiaoping378.github.io/docs/4-cloud/%E8%A7%A3%E8%AF%BBconsu-01/</guid><description>&lt;h2 id="概述"&gt;概述&lt;a class="td-heading-self-link" href="#%e6%a6%82%e8%bf%b0" aria-label="Heading self-link"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;介绍现在的Consul前，有必要先介绍下&lt;code&gt;Service Mesh&lt;/code&gt;的概念，&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Service Mesh&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Service Mesh是一种面向服务间安全通信的基础设施层，俗称代理服务的东西向流量。 典型的实现包含控制面板和数据面。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;控制面：跟踪记录所有的服务和访问地址，提供服务发现、健康检查、策略管理等。&lt;/li&gt;
&lt;li&gt;数据面：通过sidcar机制代理服务间的通信。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;传统 vs 微服务优势 :&lt;/em&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;单体 -&amp;gt; 微服务架构&lt;/li&gt;
&lt;li&gt;函数调用 -&amp;gt; 服务发现（熔断、健康检查）&lt;/li&gt;
&lt;li&gt;配置文件 -&amp;gt; 配置中心&lt;/li&gt;
&lt;li&gt;防火墙 -&amp;gt; 访问策略&lt;/li&gt;
&lt;li&gt;DMZ、生产区 -&amp;gt; 零信任&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Consul&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Consul是Service mesh中的控制面的实现，主要有一下几大特色：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;服务发现：分为注册服务、发现服务、健康检查三大功能。&lt;/li&gt;
&lt;li&gt;K-V存储：&lt;a href="https://github.com/etcd-io/bbolt"&gt;BoltDB&lt;/a&gt;，支持 ACID 事务、无锁并发事务 MVCC，提供 B+Tree 索引。&lt;/li&gt;
&lt;li&gt;多数据中心：多中心Gossip数据同步&lt;/li&gt;
&lt;li&gt;Servie Mesh: 利用sidecar机制实现了端到端的认证和加密通信&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="部署架构"&gt;部署架构&lt;a class="td-heading-self-link" href="#%e9%83%a8%e7%bd%b2%e6%9e%b6%e6%9e%84" aria-label="Heading self-link"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;下图为经典的多中心consul集群配置。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://xiaoping378.github.io/images/%E8%A7%A3%E8%AF%BBconsu-01-2022-02-16-15-57-53.png" alt=""&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;每个datacenter，都有N个Server和M个Client节点。因为网络延迟对Consul分布式一致性的性能影响，会出现节点越多，共识越慢的现象，server节点一般推荐为3~5个，但client节点没有限制。&lt;/li&gt;
&lt;li&gt;Client主要充当DNS server、负载均衡和健康检查的作用。&lt;/li&gt;
&lt;li&gt;Server实现数据的分布式存储一致性，一般用来存储节点状态、注册的服务信息、应用配置、通信策略等。&lt;/li&gt;
&lt;li&gt;Consul在选主和数据事务中都使用了Raft算法，但是其WAN(多个数据中心间)、LAN(节点间)通信、故障广播使用了Gossip算法（流行病协议）。&lt;/li&gt;
&lt;li&gt;在单集群内，Consul server默认的Follower节点收到读写请求后，会转发给Leader处理&lt;/li&gt;
&lt;li&gt;若查询的服务不在本集群，本地的Leader转发给远程集群的Leader处理。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="运维高可用管理"&gt;运维高可用管理&lt;a class="td-heading-self-link" href="#%e8%bf%90%e7%bb%b4%e9%ab%98%e5%8f%af%e7%94%a8%e7%ae%a1%e7%90%86" aria-label="Heading self-link"&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;目前分布式系统的高可靠实现，均受限于&lt;strong&gt;CAP&lt;/strong&gt;（一致性（Consistency）、可用性（Availability）和分区容错性（Partition tolerance））理论，根据不同业务场景的会采取三者之间的平衡取舍。本文的Consul是采用Raft算法来实现的，采用此算法的还有EverDB、RocketDB、Etcd、Kafka3等系统。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Raft算法状态机&lt;/strong&gt;：&lt;/p&gt;
&lt;p&gt;&lt;img src="https://xiaoping378.github.io/images/%E8%A7%A3%E8%AF%BBconsu-01-2022-02-16-14-50-29.png" alt=""&gt;&lt;/p&gt;
&lt;p&gt;主要有三种状态&lt;code&gt;Follower&lt;/code&gt;、&lt;code&gt;Candidate&lt;/code&gt;和&lt;code&gt;Leader&lt;/code&gt;，其中值得关注有以下几个方面：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;第一次启动后，默认进入为&lt;code&gt;Follower&lt;/code&gt;，经过随机时间（Election Time）后，进入&lt;code&gt;Candidate&lt;/code&gt;状态，发起投票流程。&lt;/li&gt;
&lt;li&gt;收到大多数节点投票，可以成为&lt;code&gt;Leader&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;非拜占庭环境，每进行一次选举，选举周期Term就回自加1，默认大家都遵从term高的节点&lt;/li&gt;
&lt;li&gt;选主成功后，Leader会发起心跳保活&lt;/li&gt;
&lt;li&gt;Follower可以根据CAP相性调整，一般是收到请求后转发给Leader处理。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;详情可查看&lt;a href="http://thesecretlivesofdata.com/raft/"&gt;动画&lt;/a&gt;展示。&lt;/p&gt;</description></item><item><title>解读Kafka</title><link>https://xiaoping378.github.io/docs/4-cloud/kafka-0/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://xiaoping378.github.io/docs/4-cloud/kafka-0/</guid><description/></item></channel></rss>